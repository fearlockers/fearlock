  <script>
    // Supabase初期化
    const supabaseUrl = 'https://tvdckgrexwhqrzszynjh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2ZGNrZ3JleHdocXJ6c3p5bmpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUzMTQzNTIsImV4cCI6MjA2MDg5MDM1Mn0.ZZTp66LPji6NOXfI9X7ece1gm2RN6f9vwFHVw3rqb2I';
    
    // Cookie関連のヘルパー関数
    function setCookie(name, value, days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "; expires=" + date.toUTCString();
        document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/; SameSite=Strict";
    }

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) {
                return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
        }
        return null;
    }

    function removeCookie(name) {
        document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT; SameSite=Strict';
    }
    
    // Supabaseクライアントの初期化（Cookieストレージ使用）
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
        auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: false,
            storageKey: 'sb-session-cookie',
            storage: {
                getItem: (key) => {
                    return getCookie(key);
                },
                setItem: (key, value) => {
                    setCookie(key, value, 7); // 7日間有効なCookie
                },
                removeItem: (key) => {
                    removeCookie(key);
                }
            }
        }
    });

    // ページ読み込み時に既存のセッションをチェック
    document.addEventListener('DOMContentLoaded', async () => {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (session) {
        // 既にログイン済みの場合はダッシュボードへリダイレクト
        window.location.href = 'dashboard.html';
      }
    });

    // ログインフォームのイベントリスナー
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const status = document.getElementById('status');
      status.textContent = 'ログイン中...';
      status.className = 'message';

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (error) {
          status.textContent = 'ログイン失敗: ' + error.message;
          status.className = 'message error';
        } else {
          status.textContent = 'ログイン成功！リダイレクト中...';
          status.className = 'message success';
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1000);
        }
      } catch (err) {
        status.textContent = 'エラーが発生しました: ' + err.message;
        status.className = 'message error';
      }
    });
  </script> 