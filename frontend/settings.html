<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設定 - FEARLOCK</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
</head>
<body class="camuquotes-body">
    <!-- トップヘッダー -->
    <header class="top-header">
        <div class="header-container">
            <div class="header-left">
                <button class="bento-menu-btn" onclick="toggleBentoMenu()">
                    <div class="bento-grid">
                        <div class="bento-dot"></div>
                        <div class="bento-dot"></div>
                        <div class="bento-dot"></div>
                        <div class="bento-dot"></div>
                        <div class="bento-dot"></div>
                        <div class="bento-dot"></div>
                        <div class="bento-dot"></div>
                        <div class="bento-dot"></div>
                        <div class="bento-dot"></div>
                    </div>
                </button>
                <div class="logo-section">
                    <span class="logo-text">FEARLOCK</span>
                </div>
            </div>
            
            <nav class="top-nav">
                <a href="dashboard.html" class="nav-item">ダッシュボード</a>
                <a href="projects.html" class="nav-item">プロジェクト</a>
                <a href="vulnerability-scan.html" class="nav-item">脆弱性スキャン</a>
                <a href="analysis.html" class="nav-item">分析</a>
                <a href="reports.html" class="nav-item">レポート</a>
                <a href="settings.html" class="nav-item active">設定</a>
            </nav>
            
            <div class="header-right">
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="help-btn">
                    <i class="fas fa-question-circle"></i>
                </button>
                <button class="settings-btn">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="user-menu">
                    <button class="user-avatar" onclick="toggleUserMenu()">
                        <img src="https://via.placeholder.com/32x32/4B45A9/FFFFFF?text=U" alt="User Avatar">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-info">
                            <div class="user-name" id="user-name">ユーザー</div>
                            <div class="user-email" id="user-email">user@example.com</div>
                        </div>
                        <hr class="dropdown-divider">
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-user"></i>
                            プロフィール
                        </a>
                        <a href="settings.html" class="dropdown-item">
                            <i class="fas fa-cog"></i>
                            設定
                        </a>
                        <hr class="dropdown-divider">
                        <button class="dropdown-item" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            ログアウト
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ベントメニュードロップダウン -->
        <div class="bento-dropdown" id="bentoDropdown">
            <div class="bento-dropdown-content">
                <div class="bento-apps-grid">
                    <a href="dashboard.html" class="bento-app-item">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>ダッシュボード</span>
                    </a>
                    <a href="projects.html" class="bento-app-item">
                        <i class="fas fa-folder"></i>
                        <span>プロジェクト</span>
                    </a>
                    <a href="vulnerability-scan.html" class="bento-app-item">
                        <i class="fas fa-search"></i>
                        <span>脆弱性スキャン</span>
                    </a>
                    <a href="analysis.html" class="bento-app-item">
                        <i class="fas fa-chart-line"></i>
                        <span>分析</span>
                    </a>
                    <a href="reports.html" class="bento-app-item">
                        <i class="fas fa-file-alt"></i>
                        <span>レポート</span>
                    </a>
                    <a href="settings.html" class="bento-app-item active">
                        <i class="fas fa-cog"></i>
                        <span>設定</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="main-content">
        <div class="content-container">
            <!-- ページヘッダー -->
            <div class="page-header">
                <h1>設定</h1>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="exportSettings()">
                        <i class="fas fa-download"></i>
                        設定エクスポート
                    </button>
                    <button class="btn btn-primary" onclick="saveAllSettings()">
                        <i class="fas fa-save"></i>
                        すべて保存
                    </button>
                </div>
            </div>

            <!-- 設定ナビゲーション -->
            <div class="settings-nav">
                <button class="settings-nav-item active" onclick="showSettingsSection('general')">
                    <i class="fas fa-cog"></i>
                    一般設定
                </button>
                <button class="settings-nav-item" onclick="showSettingsSection('security')">
                    <i class="fas fa-shield-alt"></i>
                    セキュリティ
                </button>
                <button class="settings-nav-item" onclick="showSettingsSection('notifications')">
                    <i class="fas fa-bell"></i>
                    通知設定
                </button>
                <button class="settings-nav-item" onclick="showSettingsSection('integrations')">
                    <i class="fas fa-plug"></i>
                    連携設定
                </button>
                <button class="settings-nav-item" onclick="showSettingsSection('users')">
                    <i class="fas fa-users"></i>
                    ユーザー管理
                </button>
                <button class="settings-nav-item" onclick="showSettingsSection('billing')">
                    <i class="fas fa-credit-card"></i>
                    請求・プラン
                </button>
            </div>

            <!-- 一般設定 -->
            <div class="settings-section active" id="general-settings">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2>一般設定</h2>
                        <p>基本的なシステム設定を管理します</p>
                    </div>
                    <div class="settings-content">
                        <div class="form-group">
                            <label for="organizationName">組織名</label>
                            <input type="text" id="organizationName" value="株式会社サンプル">
                        </div>
                        <div class="form-group">
                            <label for="timezone">タイムゾーン</label>
                            <select id="timezone">
                                <option value="Asia/Tokyo" selected>Asia/Tokyo (JST)</option>
                                <option value="UTC">UTC</option>
                                <option value="America/New_York">America/New_York (EST)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="language">言語</label>
                            <select id="language">
                                <option value="ja" selected>日本語</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateFormat">日付形式</label>
                            <select id="dateFormat">
                                <option value="YYYY/MM/DD" selected>YYYY/MM/DD</option>
                                <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" checked>
                                ダークモードを有効にする
                            </label>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-header">
                        <h3>スキャン設定</h3>
                        <p>デフォルトのスキャン動作を設定します</p>
                    </div>
                    <div class="settings-content">
                        <div class="form-group">
                            <label for="defaultScanType">デフォルトスキャンタイプ</label>
                            <select id="defaultScanType">
                                <option value="quick">クイックスキャン</option>
                                <option value="full" selected>フルスキャン</option>
                                <option value="deep">ディープスキャン</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maxConcurrentScans">同時実行スキャン数</label>
                            <input type="number" id="maxConcurrentScans" value="3" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" checked>
                                スキャン完了時に自動でレポートを生成
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox">
                                低優先度の脆弱性を自動で無視
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- セキュリティ設定 -->
            <div class="settings-section" id="security-settings">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2>セキュリティ設定</h2>
                        <p>アカウントとシステムのセキュリティを管理します</p>
                    </div>
                    <div class="settings-content">
                        <div class="form-group">
                            <label for="sessionTimeout">セッションタイムアウト（分）</label>
                            <select id="sessionTimeout">
                                <option value="30">30分</option>
                                <option value="60" selected>1時間</option>
                                <option value="120">2時間</option>
                                <option value="480">8時間</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="passwordPolicy">パスワードポリシー</label>
                            <select id="passwordPolicy">
                                <option value="basic">基本（8文字以上）</option>
                                <option value="standard" selected>標準（8文字以上、大小英数字）</option>
                                <option value="strict">厳格（12文字以上、記号含む）</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" checked>
                                二要素認証を有効にする
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" checked>
                                ログイン試行回数制限を有効にする
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox">
                                IPアドレス制限を有効にする
                            </label>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-header">
                        <h3>API設定</h3>
                        <p>API アクセスとセキュリティを管理します</p>
                    </div>
                    <div class="settings-content">
                        <div class="form-group">
                            <label for="apiRateLimit">APIレート制限（リクエスト/分）</label>
                            <input type="number" id="apiRateLimit" value="100" min="10" max="1000">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" checked>
                                API キーの定期ローテーションを有効にする
                            </label>
                        </div>
                        <div class="api-keys-section">
                            <h4>APIキー管理</h4>
                            <div class="api-key-item">
                                <div class="api-key-info">
                                    <strong>Production API Key</strong>
                                    <small>作成日: 2024年1月1日</small>
                                </div>
                                <div class="api-key-actions">
                                    <button class="btn btn-outline btn-sm" onclick="regenerateApiKey('prod')">
                                        <i class="fas fa-sync"></i>
                                        再生成
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="revokeApiKey('prod')">
                                        <i class="fas fa-trash"></i>
                                        削除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 通知設定 -->
            <div class="settings-section" id="notifications-settings">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2>通知設定</h2>
                        <p>メール通知とアラートの設定を管理します</p>
                    </div>
                    <div class="settings-content">
                        <div class="notification-group">
                            <h4>脆弱性検出通知</h4>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked>
                                    緊急レベルの脆弱性が検出された時
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked>
                                    高レベルの脆弱性が検出された時
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox">
                                    中レベルの脆弱性が検出された時
                                </label>
                            </div>
                        </div>

                        <div class="notification-group">
                            <h4>スキャン通知</h4>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked>
                                    スキャン完了時
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox">
                                    スキャン失敗時
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox">
                                    スキャン開始時
                                </label>
                            </div>
                        </div>

                        <div class="notification-group">
                            <h4>レポート通知</h4>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked>
                                    定期レポート生成時
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox">
                                    レポート共有時
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="notificationEmail">通知先メールアドレス</label>
                            <input type="email" id="notificationEmail" value="admin@example.com">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 連携設定 -->
            <div class="settings-section" id="integrations-settings">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2>連携設定</h2>
                        <p>外部サービスとの連携を管理します</p>
                    </div>
                    <div class="settings-content">
                        <div class="integration-item">
                            <div class="integration-info">
                                <div class="integration-icon">
                                    <i class="fab fa-slack"></i>
                                </div>
                                <div class="integration-details">
                                    <h4>Slack</h4>
                                    <p>チームチャンネルに通知を送信</p>
                                </div>
                            </div>
                            <div class="integration-status">
                                <span class="status-badge connected">
                                    <i class="fas fa-check"></i>
                                    接続済み
                                </span>
                                <button class="btn btn-outline btn-sm" onclick="configureIntegration('slack')">
                                    設定
                                </button>
                            </div>
                        </div>

                        <div class="integration-item">
                            <div class="integration-info">
                                <div class="integration-icon">
                                    <i class="fab fa-microsoft"></i>
                                </div>
                                <div class="integration-details">
                                    <h4>Microsoft Teams</h4>
                                    <p>チームチャンネルに通知を送信</p>
                                </div>
                            </div>
                            <div class="integration-status">
                                <span class="status-badge disconnected">
                                    <i class="fas fa-times"></i>
                                    未接続
                                </span>
                                <button class="btn btn-primary btn-sm" onclick="connectIntegration('teams')">
                                    接続
                                </button>
                            </div>
                        </div>

                        <div class="integration-item">
                            <div class="integration-info">
                                <div class="integration-icon">
                                    <i class="fab fa-jira"></i>
                                </div>
                                <div class="integration-details">
                                    <h4>Jira</h4>
                                    <p>脆弱性を自動でチケット化</p>
                                </div>
                            </div>
                            <div class="integration-status">
                                <span class="status-badge disconnected">
                                    <i class="fas fa-times"></i>
                                    未接続
                                </span>
                                <button class="btn btn-primary btn-sm" onclick="connectIntegration('jira')">
                                    接続
                                </button>
                            </div>
                        </div>

                        <div class="integration-item">
                            <div class="integration-info">
                                <div class="integration-icon">
                                    <i class="fab fa-github"></i>
                                </div>
                                <div class="integration-details">
                                    <h4>GitHub</h4>
                                    <p>リポジトリの自動スキャン</p>
                                </div>
                            </div>
                            <div class="integration-status">
                                <span class="status-badge connected">
                                    <i class="fas fa-check"></i>
                                    接続済み
                                </span>
                                <button class="btn btn-outline btn-sm" onclick="configureIntegration('github')">
                                    設定
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ユーザー管理 -->
            <div class="settings-section" id="users-settings">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2>ユーザー管理</h2>
                        <p>チームメンバーとアクセス権限を管理します</p>
                        <button class="btn btn-primary" onclick="showInviteModal()">
                            <i class="fas fa-user-plus"></i>
                            ユーザー招待
                        </button>
                    </div>
                    <div class="settings-content">
                        <div class="users-table">
                            <div class="table-header">
                                <div>ユーザー</div>
                                <div>役割</div>
                                <div>最終ログイン</div>
                                <div>ステータス</div>
                                <div>アクション</div>
                            </div>

                            <div class="table-row">
                                <div class="user-cell">
                                    <img src="https://via.placeholder.com/40x40/4B45A9/FFFFFF?text=T" alt="Avatar" class="user-avatar-small">
                                    <div class="user-info">
                                        <strong>田中 太郎</strong>
                                        <small>tanaka@example.com</small>
                                    </div>
                                </div>
                                <div>
                                    <span class="role-badge admin">管理者</span>
                                </div>
                                <div>2024年1月15日 14:30</div>
                                <div>
                                    <span class="status-badge active">
                                        <i class="fas fa-circle"></i>
                                        アクティブ
                                    </span>
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-sm" onclick="editUser(1)">
                                        <i class="fas fa-edit"></i>
                                        編集
                                    </button>
                                </div>
                            </div>

                            <div class="table-row">
                                <div class="user-cell">
                                    <img src="https://via.placeholder.com/40x40/10B981/FFFFFF?text=S" alt="Avatar" class="user-avatar-small">
                                    <div class="user-info">
                                        <strong>佐藤 花子</strong>
                                        <small>sato@example.com</small>
                                    </div>
                                </div>
                                <div>
                                    <span class="role-badge editor">編集者</span>
                                </div>
                                <div>2024年1月14日 16:45</div>
                                <div>
                                    <span class="status-badge active">
                                        <i class="fas fa-circle"></i>
                                        アクティブ
                                    </span>
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-sm" onclick="editUser(2)">
                                        <i class="fas fa-edit"></i>
                                        編集
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="removeUser(2)">
                                        <i class="fas fa-trash"></i>
                                        削除
                                    </button>
                                </div>
                            </div>

                            <div class="table-row">
                                <div class="user-cell">
                                    <img src="https://via.placeholder.com/40x40/F59E0B/FFFFFF?text=Y" alt="Avatar" class="user-avatar-small">
                                    <div class="user-info">
                                        <strong>山田 次郎</strong>
                                        <small>yamada@example.com</small>
                                    </div>
                                </div>
                                <div>
                                    <span class="role-badge viewer">閲覧者</span>
                                </div>
                                <div>2024年1月10日 09:15</div>
                                <div>
                                    <span class="status-badge inactive">
                                        <i class="fas fa-circle"></i>
                                        非アクティブ
                                    </span>
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-outline btn-sm" onclick="editUser(3)">
                                        <i class="fas fa-edit"></i>
                                        編集
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="removeUser(3)">
                                        <i class="fas fa-trash"></i>
                                        削除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 請求・プラン -->
            <div class="settings-section" id="billing-settings">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2>請求・プラン</h2>
                        <p>サブスクリプションと請求情報を管理します</p>
                    </div>
                    <div class="settings-content">
                        <div class="current-plan">
                            <div class="plan-info">
                                <h3>現在のプラン: Professional</h3>
                                <p>月額 ¥9,800 / 月</p>
                                <p>次回請求日: 2024年2月15日</p>
                            </div>
                            <div class="plan-actions">
                                <button class="btn btn-outline" onclick="changePlan()">
                                    プラン変更
                                </button>
                                <button class="btn btn-danger" onclick="cancelSubscription()">
                                    解約
                                </button>
                            </div>
                        </div>

                        <div class="billing-history">
                            <h4>請求履歴</h4>
                            <div class="billing-table">
                                <div class="table-header">
                                    <div>請求日</div>
                                    <div>金額</div>
                                    <div>ステータス</div>
                                    <div>アクション</div>
                                </div>

                                <div class="table-row">
                                    <div>2024年1月15日</div>
                                    <div>¥9,800</div>
                                    <div>
                                        <span class="status-badge paid">
                                            <i class="fas fa-check"></i>
                                            支払済み
                                        </span>
                                    </div>
                                    <div>
                                        <button class="btn btn-outline btn-sm" onclick="downloadInvoice(1)">
                                            <i class="fas fa-download"></i>
                                            請求書
                                        </button>
                                    </div>
                                </div>

                                <div class="table-row">
                                    <div>2023年12月15日</div>
                                    <div>¥9,800</div>
                                    <div>
                                        <span class="status-badge paid">
                                            <i class="fas fa-check"></i>
                                            支払済み
                                        </span>
                                    </div>
                                    <div>
                                        <button class="btn btn-outline btn-sm" onclick="downloadInvoice(2)">
                                            <i class="fas fa-download"></i>
                                            請求書
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ユーザー招待モーダル -->
    <div class="modal" id="inviteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ユーザー招待</h2>
                <button class="modal-close" onclick="hideInviteModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="inviteForm">
                    <div class="form-group">
                        <label for="inviteEmail">メールアドレス</label>
                        <input type="email" id="inviteEmail" name="inviteEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="inviteRole">役割</label>
                        <select id="inviteRole" name="inviteRole" required>
                            <option value="">選択してください</option>
                            <option value="admin">管理者</option>
                            <option value="editor">編集者</option>
                            <option value="viewer">閲覧者</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inviteMessage">招待メッセージ（任意）</label>
                        <textarea id="inviteMessage" name="inviteMessage" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideInviteModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="inviteUser()">招待送信</button>
            </div>
        </div>
    </div>

    <script>
        // Supabaseの設定
        const supabaseUrl = 'https://tvdckgrexwhqrzszynjh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2ZGNrZ3JleHdocXJ6c3p5bmpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUzMTQzNTIsImV4cCI6MjA2MDg5MDM1Mn0.ZZTp66LPji6NOXfI9X7ece1gm2RN6f9vwFHVw3rqb2I';
        
        // Cookie関連のヘルパー関数
        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "; expires=" + date.toUTCString();
            document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/; SameSite=Lax";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) {
                    return decodeURIComponent(c.substring(nameEQ.length, c.length));
                }
            }
            return null;
        }

        function removeCookie(name) {
            document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT; SameSite=Lax';
        }
        
        // Supabaseクライアントの初期化
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: false,
                storageKey: 'sb-session-cookie',
                storage: {
                    getItem: (key) => getCookie(key),
                    setItem: (key, value) => setCookie(key, value, 7),
                    removeItem: (key) => removeCookie(key)
                }
            }
        });

        // ユーザーメニューの表示/非表示
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // ベントメニューの表示/非表示
        function toggleBentoMenu() {
            const dropdown = document.getElementById('bentoDropdown');
            dropdown.classList.toggle('show');
        }

        // 設定セクションの切り替え
        function showSettingsSection(sectionName) {
            // すべてのセクションを非表示
            const sections = document.querySelectorAll('.settings-section');
            sections.forEach(section => section.classList.remove('active'));
            
            // すべてのナビアイテムを非アクティブ
            const navItems = document.querySelectorAll('.settings-nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            // 選択されたセクションを表示
            document.getElementById(`${sectionName}-settings`).classList.add('active');
            
            // 対応するナビアイテムをアクティブ
            event.target.classList.add('active');
        }

        // モーダル表示/非表示
        function showInviteModal() {
            document.getElementById('inviteModal').style.display = 'flex';
        }

        function hideInviteModal() {
            document.getElementById('inviteModal').style.display = 'none';
        }

        // 設定操作
        function saveAllSettings() {
            alert('すべての設定を保存しました');
        }

        function exportSettings() {
            alert('設定をエクスポートします');
        }

        // セキュリティ操作
        function regenerateApiKey(type) {
            if (confirm('APIキーを再生成しますか？古いキーは無効になります。')) {
                alert(`${type} APIキーを再生成しました`);
            }
        }

        function revokeApiKey(type) {
            if (confirm('APIキーを削除しますか？この操作は取り消せません。')) {
                alert(`${type} APIキーを削除しました`);
            }
        }

        // 連携操作
        function connectIntegration(service) {
            alert(`${service}との連携を設定します`);
        }

        function configureIntegration(service) {
            alert(`${service}の設定を変更します`);
        }

        // ユーザー管理
        function editUser(id) {
            alert(`ユーザー ${id} を編集します`);
        }

        function removeUser(id) {
            if (confirm('このユーザーを削除しますか？')) {
                alert(`ユーザー ${id} を削除しました`);
            }
        }

        function inviteUser() {
            const form = document.getElementById('inviteForm');
            const formData = new FormData(form);
            
            alert('ユーザーを招待しました');
            hideInviteModal();
            form.reset();
        }

        // 請求・プラン操作
        function changePlan() {
            alert('プラン変更画面に移動します');
        }

        function cancelSubscription() {
            if (confirm('サブスクリプションを解約しますか？')) {
                alert('解約手続きを開始しました');
            }
        }

        function downloadInvoice(id) {
            alert(`請求書 ${id} をダウンロードします`);
        }

        // ログアウト
        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                // Cookieをクリア
                removeCookie('sb-session-cookie');
                
                // ログインページにリダイレクト
                window.location.href = 'login.html';
            } catch (error) {
                console.error('ログアウトエラー:', error);
                alert('ログアウト中にエラーが発生しました');
            }
        }

        // 外部クリックでドロップダウンを閉じる
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            const bentoMenu = document.querySelector('.bento-menu-btn');
            
            if (!userMenu.contains(event.target)) {
                document.getElementById('userDropdown').classList.remove('show');
            }
            
            if (!bentoMenu.contains(event.target)) {
                document.getElementById('bentoDropdown').classList.remove('show');
            }
        });

        // 認証チェック
        async function checkAuth() {
            try {
                const { data, error } = await supabase.auth.getSession();
                
                if (error || !data.session) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // ユーザー情報を表示
                const userEmail = data.session.user.email;
                document.getElementById('user-email').textContent = userEmail;
                document.getElementById('user-name').textContent = userEmail.split('@')[0];
                
            } catch (error) {
                console.error('認証チェックエラー:', error);
                window.location.href = 'login.html';
            }
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });
    </script>
</body>
</html> 